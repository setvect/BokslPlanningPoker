# PRD: 온라인 타자 게임

## 1. 개요

### 1.1 배경
복슬 플래닝 포커 서비스에 부가 기능으로 온라인 타자 게임을 추가한다. 플래닝 포커 대기 시간에 팀원들이 함께 즐길 수 있는 간단한 미니 게임으로, 90년대 PC 통신 시절의 타자 게임에서 영감을 받았다.

### 1.2 목표
- 플래닝 포커 세션 사이의 대기 시간을 활용한 팀 빌딩 활동 제공
- 실시간 멀티플레이어 타자 경쟁 게임 구현
- 기존 플래닝 포커 인프라(Socket.io, 사용자 시스템)를 재활용한 효율적인 개발

### 1.3 범위
- 타자 게임방 생성 및 참여 기능
- 실시간 타자 경쟁 게임 로직
- 참여자 간 진행 상황 실시간 공유
- 순위 시스템

## 2. 기능 요구사항

### 2.1 메인 화면

#### 2.1.1 네비게이션
- 메인 화면에 플래닝 포커 섹션과 타자 게임 섹션을 함께 표시
- 각 섹션에서 방 만들기 및 활성화된 방 목록 제공

#### 2.1.2 타자 게임방 목록
- 활성화된 타자 게임방 목록 표시
- 플래닝 포커 방 목록과 동일한 UI 패턴 적용
- 방 이름, 현재 참가자 수 표시

#### 2.1.3 방 만들기
- 방 이름 입력
- 사용자 이름은 플래닝 포커와 공유 (localStorage)

### 2.2 게임방

#### 2.2.1 방 설정
- 최대 참가자 수: 20명
- 최소 참가자 수: 1명 (혼자 연습 가능)
- 비활성 방 자동 정리: 1시간 (플래닝 포커와 동일)

#### 2.2.2 참가자 관리
- 중복 이름 자동 번호 부여 (플래닝 포커와 동일 로직)
- 게임 중 입장 시 다음 라운드부터 참여 가능
- 게임 중 퇴장 시 해당 라운드 자동 탈락 처리

### 2.3 게임 진행

#### 2.3.1 게임 상태
```
WAITING → COUNTDOWN → PLAYING → ROUND_END → WAITING → COUNTDOWN → PLAYING → ...
```
- **WAITING**: 게임 시작 대기 (최초: 참가자 모집, 라운드 간: 3초 휴식)
- **COUNTDOWN**: 라운드 시작 전 3초 카운트다운
- **PLAYING**: 타자 입력 진행 중
- **ROUND_END**: 라운드 종료, 순위 표시 후 3초 대기(WAITING)로 전환

#### 2.3.2 게임 시작
- 참가자 중 아무나 "게임 시작" 버튼 클릭 가능
- 게임 시작 시 3초 카운트다운 후 문장 제시

#### 2.3.3 라운드 진행
1. 3초 카운트다운
2. 랜덤 문장 제시
3. 참가자들 타자 입력
4. 1등 완료 시 5초 타이머 시작
5. 5초 후 라운드 종료 및 순위 확정
6. 3초 대기 (WAITING) - 다음 라운드 준비 시간
7. 자동으로 다음 라운드 시작 (3초 카운트다운부터)

#### 2.3.4 라운드 종료 조건
- 1등 완료 후 5초 경과
- 제한 시간 없음 (아무도 완료하지 않으면 계속 진행)

### 2.4 타자 입력

#### 2.4.1 문장 제시
- 50자 이내의 한글 또는 영문 문장
- 문장 데이터는 별도 파일로 관리
- 같은 방에서 연속으로 같은 문장 제시 방지
- 모든 문장이 사용되면 다시 랜덤하게 순환

#### 2.4.2 복사 방지
- 입력 필드에 붙여넣기(paste) 이벤트 차단
- 제시 문장의 띄어쓰기 위치에 시각적 특수 문자 삽입
  - 사용자는 일반 스페이스바로 입력
  - 정답 비교 시 원본 문장과 비교

#### 2.4.3 오타 처리
- 입력 중 오타 발생 시 해당 글자 빨간색 표시
- 한글: 완전한 글자 입력 후 오타 체크 (조합 중에는 체크하지 않음)
- 영문: 즉시 오타 체크

#### 2.4.4 입력 완료
- 모든 문장 입력 후 Enter 키로 완료
- 오타가 1개 이상 있으면 완료 불가
- 완료 시 순위 확정

### 2.5 실시간 진행 상황

#### 2.5.1 다른 참가자 진행 상황 표시
- 각 참가자의 실시간 입력 텍스트 표시
- 작은 폰트로 대략적인 진행 상황 파악 가능하게
- 참가자가 많을 경우 일부만 표시 가능

#### 2.5.2 반응형 처리
- 모바일에서는 다른 참가자 진행 상황 숨김 가능
- 본인 입력 영역은 항상 표시

### 2.6 순위 시스템

#### 2.6.1 순위 표시
- 별도 화면 영역에 현재 라운드 순위 표시
- 완료 순서대로 1등, 2등, 3등... 표시
- 미완료 참가자는 순위 없음

#### 2.6.2 순위 유지
- 라운드 종료 후 순위는 다음 라운드 시작 전까지 유지
- 다음 라운드에서 1등이 나오면 순위 초기화

## 3. 비기능 요구사항

### 3.1 성능
- 실시간 타자 입력 동기화 지연 최소화
- Socket.io를 통한 효율적인 이벤트 전송

### 3.2 사용성
- 플래닝 포커와 일관된 UI/UX
- 다크/라이트 모드 지원
- 모바일 반응형 지원

### 3.3 안정성
- 네트워크 재연결 시 게임 상태 복원
- 참가자 연결 끊김 시 적절한 처리

## 4. 기술 설계

### 4.1 공유 타입 정의 (shared/)

```typescript
// 타자 게임 상태
type TypingGameStatus = 'WAITING' | 'COUNTDOWN' | 'PLAYING' | 'ROUND_END';

// 타자 게임 참가자
interface TypingPlayer {
  odei: string;
  name: string;
  currentInput: string;
  isCompleted: boolean;
  completedAt: number | null;  // 완료 시간 (타임스탬프)
  rank: number | null;
}

// 타자 게임방
interface TypingRoom {
  id: string;
  name: string;
  players: TypingPlayer[];
  status: TypingGameStatus;
  currentSentence: string;
  displaySentence: string;  // 특수문자가 포함된 표시용 문장
  roundNumber: number;
  usedSentenceIndexes: number[];  // 이미 사용된 문장 인덱스
  firstCompletedAt: number | null;  // 1등 완료 시간
  countdown: number | null;  // 카운트다운 남은 초
}
```

### 4.2 Socket 이벤트 (shared/socket-events.ts)

```typescript
// 클라이언트 → 서버
TYPING_CREATE_ROOM: 'typing_create_room'
TYPING_JOIN_ROOM: 'typing_join_room'
TYPING_LEAVE_ROOM: 'typing_leave_room'
TYPING_START_GAME: 'typing_start_game'
TYPING_UPDATE_INPUT: 'typing_update_input'
TYPING_COMPLETE: 'typing_complete'

// 서버 → 클라이언트
TYPING_ROOM_LIST: 'typing_room_list'
TYPING_ROOM_UPDATE: 'typing_room_update'
TYPING_GAME_START: 'typing_game_start'
TYPING_COUNTDOWN: 'typing_countdown'
TYPING_ROUND_START: 'typing_round_start'
TYPING_PLAYER_UPDATE: 'typing_player_update'
TYPING_PLAYER_COMPLETE: 'typing_player_complete'
TYPING_ROUND_END: 'typing_round_end'
```

### 4.3 서버 모델 (server/src/models/)

#### TypingRoom.ts
- 타자 게임방 상태 관리
- 참가자 Map 관리
- 라운드 진행 로직

#### TypingSentences.ts
- 문장 데이터 로드 및 관리
- 랜덤 문장 선택 (중복 방지 로직 포함)
- 특수문자 삽입 로직

### 4.4 클라이언트 구조 (client/src/)

#### hooks/useTypingGame.ts
- 타자 게임 상태 관리
- Socket 이벤트 핸들링
- 입력 검증 로직

#### components/typing/
- TypingGameSection.tsx: 메인 화면 타자 게임 섹션
- TypingRoom.tsx: 게임방 메인 컴포넌트
- TypingInput.tsx: 타자 입력 컴포넌트
- TypingProgress.tsx: 다른 참가자 진행 상황
- TypingRanking.tsx: 순위 표시
- TypingCountdown.tsx: 카운트다운 표시

### 4.5 문장 데이터 파일

```
server/src/data/typing-sentences.json
```

```json
{
  "sentences": [
    "빠른 갈색 여우가 게으른 개를 뛰어넘는다",
    "The quick brown fox jumps over the lazy dog",
    "오늘 하루도 화이팅 합시다",
    ...
  ]
}
```

## 5. UI/UX 설계

### 5.1 메인 화면 레이아웃

```
┌─────────────────────────────────────────────────────┐
│                     헤더                             │
├─────────────────────────┬───────────────────────────┤
│   플래닝 포커 섹션       │     타자 게임 섹션         │
│                         │                           │
│  [방 만들기]            │  [방 만들기]              │
│                         │                           │
│  ┌─────────────────┐   │  ┌─────────────────┐      │
│  │ 방 목록          │   │  │ 방 목록          │      │
│  │ - 방1 (3/20)    │   │  │ - 타자방1 (5/20) │      │
│  │ - 방2 (7/20)    │   │  │ - 타자방2 (2/20) │      │
│  └─────────────────┘   │  └─────────────────┘      │
└─────────────────────────┴───────────────────────────┘
```

### 5.2 게임방 레이아웃

```
┌─────────────────────────────────────────────────────┐
│  방 이름                              [나가기]       │
├─────────────────────────────────────────────────────┤
│                                                     │
│           제시 문장 (특수문자 포함 표시)              │
│                                                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│              [내 입력 필드]                          │
│                                                     │
├─────────────────────────────┬───────────────────────┤
│   다른 참가자 진행 상황      │       순위            │
│                             │                       │
│  홍길동: 빠른 갈색 여우가... │  🥇 김철수 (12.3초)   │
│  김영희: 빠른 갈색...       │  🥈 이영희 (15.1초)   │
│  박민수: 빠른...            │  🥉 박민수 (18.7초)   │
│                             │                       │
└─────────────────────────────┴───────────────────────┘
```

### 5.3 상태별 화면

#### WAITING 상태
- "게임 시작" 버튼 표시
- 참가자 목록 표시

#### COUNTDOWN 상태
- 화면 중앙에 큰 숫자로 카운트다운 (3, 2, 1)

#### PLAYING 상태
- 제시 문장 표시
- 입력 필드 활성화
- 다른 참가자 진행 상황 실시간 업데이트

#### ROUND_END 상태
- 최종 순위 표시
- 3초 후 자동으로 WAITING으로 전환

#### WAITING 상태 (라운드 간)
- "다음 라운드 준비 중..." 메시지
- 3초 대기 후 자동으로 COUNTDOWN으로 전환

## 6. 샘플 문장 데이터

```json
{
  "sentences": [
    "빠른 갈색 여우가 게으른 개를 뛰어넘는다",
    "The quick brown fox jumps over the lazy dog",
    "오늘 하루도 좋은 하루 되세요",
    "프로그래밍은 창의력과 논리력의 조화입니다",
    "Hello World is the first program we write",
    "커피 한 잔의 여유가 하루를 바꿉니다",
    "팀워크는 성공의 가장 중요한 열쇠입니다",
    "Practice makes perfect in everything",
    "작은 성공들이 모여 큰 성취를 이룹니다",
    "Never give up on your dreams"
  ]
}
```

## 7. 구현 우선순위

### Phase 1: 기본 구조
1. 공유 타입 및 Socket 이벤트 정의
2. 서버 모델 구현 (TypingRoom, TypingSentences)
3. 기본 Socket 핸들러 구현

### Phase 2: 게임 로직
4. 게임 상태 머신 구현
5. 라운드 진행 로직 구현
6. 순위 시스템 구현

### Phase 3: 클라이언트 UI
7. 메인 화면 섹션 추가
8. 게임방 UI 구현
9. 타자 입력 컴포넌트 구현
10. 실시간 진행 상황 표시

### Phase 4: 완성도
11. 복사 방지 로직 구현
12. 한글 조합 중 오타 체크 로직
13. 모바일 반응형 처리
14. 네트워크 재연결 처리

## 8. 테스트 시나리오

1. **기본 게임 플로우**: 방 생성 → 참가 → 게임 시작 → 타자 입력 → 완료 → 순위 확인
2. **혼자 연습**: 1인 게임 진행 가능 여부
3. **중도 참가**: 게임 중 입장 시 다음 라운드 참여
4. **중도 퇴장**: 게임 중 나가기 시 자동 탈락 처리
5. **오타 처리**: 한글/영문 오타 표시 및 완료 차단
6. **복사 방지**: 붙여넣기 차단 및 특수문자 표시
7. **연속 라운드**: 여러 라운드 연속 진행
8. **재연결**: 네트워크 끊김 후 재연결 시 상태 복원
